{"ast":null,"code":"// Notification & Web Push service for PWA\nimport { authService } from './authService';\nconst SW_PATH = '/sw.js';\nasync function getVapidPublicKey() {\n  var _res$data, _res$data2;\n  const res = await authService.api.get('/api/push/public-key');\n  const key = ((_res$data = res.data) === null || _res$data === void 0 ? void 0 : _res$data.publicKey) || ((_res$data2 = res.data) === null || _res$data2 === void 0 ? void 0 : _res$data2.public_key) || '';\n  if (!key) throw new Error('Clé publique VAPID manquante');\n  return urlBase64ToUint8Array(key);\n}\nfunction urlBase64ToUint8Array(base64String) {\n  const padding = '='.repeat((4 - base64String.length % 4) % 4);\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\n  const rawData = atob(base64);\n  const outputArray = new Uint8Array(rawData.length);\n  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);\n  return outputArray;\n}\nasync function registerServiceWorker() {\n  if (!('serviceWorker' in navigator)) return null;\n  try {\n    const reg = await navigator.serviceWorker.register(SW_PATH);\n    return reg;\n  } catch (e) {\n    console.warn('[Notifications] SW register failed', e);\n    return null;\n  }\n}\nasync function requestPermissionIfNeeded() {\n  if (typeof Notification === 'undefined') return 'denied';\n  if (Notification.permission === 'default') {\n    try {\n      const p = await Notification.requestPermission();\n      return p;\n    } catch {\n      return 'denied';\n    }\n  }\n  return Notification.permission;\n}\nasync function getExistingSubscription(reg) {\n  try {\n    return await reg.pushManager.getSubscription();\n  } catch {\n    return null;\n  }\n}\nasync function subscribeUserToPush() {\n  const permission = await requestPermissionIfNeeded();\n  if (permission !== 'granted') throw new Error('Permission notifications refusée');\n  const reg = (await registerServiceWorker()) || (await navigator.serviceWorker.ready);\n  if (!reg) throw new Error('Service worker indisponible');\n  const existing = await getExistingSubscription(reg);\n  if (existing) return existing;\n  const appServerKey = await getVapidPublicKey();\n  return reg.pushManager.subscribe({\n    userVisibleOnly: true,\n    applicationServerKey: appServerKey\n  });\n}\nasync function saveSubscriptionToServer(subscription) {\n  try {\n    await authService.api.post('/api/push/subscribe', subscription);\n    return true;\n  } catch (e) {\n    console.warn('[Notifications] saveSubscriptionToServer failed', e);\n    return false;\n  }\n}\nexport async function ensurePushSubscribed() {\n  const reg = await registerServiceWorker();\n  const sub = reg && (await getExistingSubscription(reg));\n  if (sub) return {\n    ok: true,\n    status: 'already',\n    subscription: sub\n  };\n  const created = await subscribeUserToPush();\n  const saved = await saveSubscriptionToServer(created.toJSON());\n  return {\n    ok: saved,\n    status: 'subscribed',\n    subscription: created\n  };\n}\nexport async function testPush() {\n  try {\n    const res = await authService.api.post('/api/push/test');\n    return res.data;\n  } catch (e) {\n    throw e;\n  }\n}\nexport async function getPermissionStatus() {\n  if (typeof Notification === 'undefined') return 'unsupported';\n  return Notification.permission;\n}","map":{"version":3,"names":["authService","SW_PATH","getVapidPublicKey","_res$data","_res$data2","res","api","get","key","data","publicKey","public_key","Error","urlBase64ToUint8Array","base64String","padding","repeat","length","base64","replace","rawData","atob","outputArray","Uint8Array","i","charCodeAt","registerServiceWorker","navigator","reg","serviceWorker","register","e","console","warn","requestPermissionIfNeeded","Notification","permission","p","requestPermission","getExistingSubscription","pushManager","getSubscription","subscribeUserToPush","ready","existing","appServerKey","subscribe","userVisibleOnly","applicationServerKey","saveSubscriptionToServer","subscription","post","ensurePushSubscribed","sub","ok","status","created","saved","toJSON","testPush","getPermissionStatus"],"sources":["C:/Users/sorbo/US/us-app/frontend/src/services/notificationService.js"],"sourcesContent":["// Notification & Web Push service for PWA\r\nimport { authService } from './authService';\r\n\r\nconst SW_PATH = '/sw.js';\r\n\r\nasync function getVapidPublicKey() {\r\n  const res = await authService.api.get('/api/push/public-key');\r\n  const key = res.data?.publicKey || res.data?.public_key || '';\r\n  if (!key) throw new Error('Clé publique VAPID manquante');\r\n  return urlBase64ToUint8Array(key);\r\n}\r\n\r\nfunction urlBase64ToUint8Array(base64String) {\r\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);\r\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');\r\n  const rawData = atob(base64);\r\n  const outputArray = new Uint8Array(rawData.length);\r\n  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);\r\n  return outputArray;\r\n}\r\n\r\nasync function registerServiceWorker() {\r\n  if (!('serviceWorker' in navigator)) return null;\r\n  try {\r\n    const reg = await navigator.serviceWorker.register(SW_PATH);\r\n    return reg;\r\n  } catch (e) {\r\n    console.warn('[Notifications] SW register failed', e);\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function requestPermissionIfNeeded() {\r\n  if (typeof Notification === 'undefined') return 'denied';\r\n  if (Notification.permission === 'default') {\r\n    try {\r\n      const p = await Notification.requestPermission();\r\n      return p;\r\n    } catch {\r\n      return 'denied';\r\n    }\r\n  }\r\n  return Notification.permission;\r\n}\r\n\r\nasync function getExistingSubscription(reg) {\r\n  try {\r\n    return await reg.pushManager.getSubscription();\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function subscribeUserToPush() {\r\n  const permission = await requestPermissionIfNeeded();\r\n  if (permission !== 'granted') throw new Error('Permission notifications refusée');\r\n\r\n  const reg = (await registerServiceWorker()) || (await navigator.serviceWorker.ready);\r\n  if (!reg) throw new Error('Service worker indisponible');\r\n\r\n  const existing = await getExistingSubscription(reg);\r\n  if (existing) return existing;\r\n\r\n  const appServerKey = await getVapidPublicKey();\r\n  return reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: appServerKey });\r\n}\r\n\r\nasync function saveSubscriptionToServer(subscription) {\r\n  try {\r\n    await authService.api.post('/api/push/subscribe', subscription);\r\n    return true;\r\n  } catch (e) {\r\n    console.warn('[Notifications] saveSubscriptionToServer failed', e);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport async function ensurePushSubscribed() {\r\n  const reg = await registerServiceWorker();\r\n  const sub = reg && (await getExistingSubscription(reg));\r\n  if (sub) return { ok: true, status: 'already', subscription: sub };\r\n  const created = await subscribeUserToPush();\r\n  const saved = await saveSubscriptionToServer(created.toJSON());\r\n  return { ok: saved, status: 'subscribed', subscription: created };\r\n}\r\n\r\nexport async function testPush() {\r\n  try {\r\n    const res = await authService.api.post('/api/push/test');\r\n    return res.data;\r\n  } catch (e) {\r\n    throw e;\r\n  }\r\n}\r\n\r\nexport async function getPermissionStatus() {\r\n  if (typeof Notification === 'undefined') return 'unsupported';\r\n  return Notification.permission;\r\n}\r\n\r\n\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}